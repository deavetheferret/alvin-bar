"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _plugin = require("@parcel/plugin");

var _Config = require("./Config");

var _logger = require("@parcel/logger");

var _crypto = _interopRequireDefault(require("crypto"));

var _utils = require("@parcel/utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const CONFIG = Symbol.for('parcel-plugin-config'); // noinspection JSUnusedGlobalSymbols

var _default = new _plugin.Namer({
  config: _Config.Config | undefined,
  delegate: null,

  async name(opts) {
    const config = this.ensureConfig(opts.options.projectRoot, opts.options.packageManager, opts.logger);

    if (!config) {
      return null;
    }

    const disable = config.developmentDisable && opts.options.mode === 'development';
    const nameFromSuper = await this.delegate.name(opts);

    if (nameFromSuper != null && !disable) {
      return this.rewrite(opts.bundle, opts.bundleGraph, opts.options, nameFromSuper, opts.logger);
    }

    return nameFromSuper;
  },

  ensureConfig(projectRoot, packageManager, logger) {
    if (!this.config) {
      const config = new _Config.Config();
      config.loadFromPackageFolder(projectRoot, logger);

      if (!config.chain) {
        throw Error('No chain namer has been found in project. Set package.json#parcel-namer-rewrite:chain to set a delegate namer ("@parcel/namer-default" by default)');
      }

      const delegatePackage = packageManager.load(config.chain, projectRoot);

      if (!delegatePackage) {
        throw Error(`'Package ${config.delegate}' is not available. Set package.json#parcel-namer-rewrite:chain to set a delegate namer ("@parcel/namer-default" by default)`);
      }

      const delegate = delegatePackage.default[CONFIG];

      if (!delegate) {
        throw Error(`Package '${config.delegate}' has been found, but it's not a namer. Set package.json#parcel-namer-rewrite:chain to set a delegate namer ("@parcel/namer-default" by default)`);
      }

      this.delegate = delegate;
      this.config = config;
    }

    return this.config;
  },

  async rewrite(bundle, bundleGraph, options, superName, logger) {
    const rule = this.config.selectRule(superName);

    if (!rule) {
      return superName;
    }

    let bundleHash = '';

    if (options.mode !== 'development' || this.config.developmentHashing) {
      if (this.config.useParcelHash) {
        bundleHash = bundle.hashReference;
      } else {
        let assets = [];
        bundle.traverseAssets(asset => assets.push(asset));

        let hash = _crypto.default.createHash('md5');

        for (let i = 0; i < assets.length; ++i) {
          const asset = assets[i];

          if (asset.filePath) {
            const fileHash = await (0, _utils.md5FromFilePath)(asset.fs, asset.filePath);
            hash.update([asset.filePath, fileHash].join(':'));
          }
        }

        bundleHash = hash.digest('hex').substr(0, 6);
      }
    } // if we need hashing - remove bundle hash placeholder


    if (bundleHash && bundle.hashReference) {
      superName = superName.replace("." + bundle.hashReference, "");
    }

    const rewrite = superName.replace(rule.test, rule.to).replace(/{(.?)hash(.?)}/, bundleHash.length > 0 ? `$1${bundleHash}$2` : '');
    if (this.config.silent !== true) logger.info({
      message: `Rewrite ${superName} -> ${rewrite}`
    });
    return rewrite;
  }

});

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9OYW1lci5qcyJdLCJuYW1lcyI6WyJDT05GSUciLCJTeW1ib2wiLCJmb3IiLCJOYW1lciIsImNvbmZpZyIsIkNvbmZpZyIsInVuZGVmaW5lZCIsImRlbGVnYXRlIiwibmFtZSIsIm9wdHMiLCJlbnN1cmVDb25maWciLCJvcHRpb25zIiwicHJvamVjdFJvb3QiLCJwYWNrYWdlTWFuYWdlciIsImxvZ2dlciIsImRpc2FibGUiLCJkZXZlbG9wbWVudERpc2FibGUiLCJtb2RlIiwibmFtZUZyb21TdXBlciIsInJld3JpdGUiLCJidW5kbGUiLCJidW5kbGVHcmFwaCIsImxvYWRGcm9tUGFja2FnZUZvbGRlciIsImNoYWluIiwiRXJyb3IiLCJkZWxlZ2F0ZVBhY2thZ2UiLCJsb2FkIiwiZGVmYXVsdCIsInN1cGVyTmFtZSIsInJ1bGUiLCJzZWxlY3RSdWxlIiwiYnVuZGxlSGFzaCIsImRldmVsb3BtZW50SGFzaGluZyIsInVzZVBhcmNlbEhhc2giLCJoYXNoUmVmZXJlbmNlIiwiYXNzZXRzIiwidHJhdmVyc2VBc3NldHMiLCJhc3NldCIsInB1c2giLCJoYXNoIiwiY3J5cHRvIiwiY3JlYXRlSGFzaCIsImkiLCJsZW5ndGgiLCJmaWxlUGF0aCIsImZpbGVIYXNoIiwiZnMiLCJ1cGRhdGUiLCJqb2luIiwiZGlnZXN0Iiwic3Vic3RyIiwicmVwbGFjZSIsInRlc3QiLCJ0byIsInNpbGVudCIsImluZm8iLCJtZXNzYWdlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxNQUFNLEdBQUdDLE1BQU0sQ0FBQ0MsR0FBUCxDQUFXLHNCQUFYLENBQWYsQyxDQUVBOztlQUNlLElBQUlDLGFBQUosQ0FBVTtBQUNyQkMsRUFBQUEsTUFBTSxFQUFFQyxpQkFBU0MsU0FESTtBQUVyQkMsRUFBQUEsUUFBUSxFQUFFLElBRlc7O0FBSXJCLFFBQU1DLElBQU4sQ0FBV0MsSUFBWCxFQUF5RjtBQUNyRixVQUFN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NUIsU0FBVSxPQUFNVCxPQUFRO0FBRHBDLEtBQVo7QUFJSixXQUFPQSxPQUFQO0FBQ0g7O0FBdEZvQixDQUFWLEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge05hbWVyfSBmcm9tICdAcGFyY2VsL3BsdWdpbic7XG5pbXBvcnQge0NvbmZpZ30gZnJvbSBcIi4vQ29uZmlnXCI7XG5pbXBvcnQge1BsdWdpbkxvZ2dlcn0gZnJvbSAnQHBhcmNlbC9sb2dnZXInO1xuaW1wb3J0IGNyeXB0byBmcm9tIFwiY3J5cHRvXCI7XG5pbXBvcnQge21kNUZyb21GaWxlUGF0aH0gZnJvbSBcIkBwYXJjZWwvdXRpbHNcIjtcblxuY29uc3QgQ09ORklHID0gU3ltYm9sLmZvcigncGFyY2VsLXBsdWdpbi1jb25maWcnKTtcblxuLy8gbm9pbnNwZWN0aW9uIEpTVW51c2VkR2xvYmFsU3ltYm9sc1xuZXhwb3J0IGRlZmF1bHQgbmV3IE5hbWVyKHtcbiAgICBjb25maWc6IENvbmZpZyB8IHVuZGVmaW5lZCxcbiAgICBkZWxlZ2F0ZTogbnVsbCxcblxuICAgIGFzeW5jIG5hbWUob3B0czogeyBidW5kbGU6IEJ1bmRsZSwgYnVuZGxlR3JhcGg6IHt9LCBvcHRpb25zOiB7fSwgbG9nZ2VyOiBQbHVnaW5Mb2dnZXIgfSkge1xuICAgICAgICBjb25zdCBjb25maWcgPSB0aGlzLmVuc3VyZUNvbmZpZyhvcHRzLm9wdGlvbnMucHJvamVjdFJvb3QsIG9wdHMub3B0aW9ucy5wYWNrYWdlTWFuYWdlciwgb3B0cy5sb2dnZXIpO1xuICAgICAgICBpZiAoIWNvbmZpZykge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkaXNhYmxlID0gY29uZmlnLmRldmVsb3BtZW50RGlzYWJsZSAmJiBvcHRzLm9wdGlvbnMubW9kZSA9PT0gJ2RldmVsb3BtZW50JztcblxuICAgICAgICBjb25zdCBuYW1lRnJvbVN1cGVyID0gYXdhaXQgdGhpcy5kZWxlZ2F0ZS5uYW1lKG9wdHMpO1xuICAgICAgICBpZiAobmFtZUZyb21TdXBlciAhPSBudWxsICYmICFkaXNhYmxlKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXdyaXRlKG9wdHMuYnVuZGxlLCBvcHRzLmJ1bmRsZUdyYXBoLCBvcHRzLm9wdGlvbnMsIG5hbWVGcm9tU3VwZXIsIG9wdHMubG9nZ2VyKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmFtZUZyb21TdXBlcjtcbiAgICB9LFxuXG4gICAgZW5zdXJlQ29uZmlnKHByb2plY3RSb290OiBzdHJpbmcsIHBhY2thZ2VNYW5hZ2VyOiB7fSwgbG9nZ2VyOiBQbHVnaW5Mb2dnZXIpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNvbmZpZykge1xuICAgICAgICAgICAgY29uc3QgY29uZmlnID0gbmV3IENvbmZpZygpO1xuICAgICAgICAgICAgY29uZmlnLmxvYWRGcm9tUGFja2FnZUZvbGRlcihwcm9qZWN0Um9vdCwgbG9nZ2VyKTtcbiAgICAgICAgICAgIGlmICghY29uZmlnLmNoYWluKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ05vIGNoYWluIG5hbWVyIGhhcyBiZWVuIGZvdW5kIGluIHByb2plY3QuIFNldCBwYWNrYWdlLmpzb24jcGFyY2VsLW5hbWVyLXJld3JpdGU6Y2hhaW4gdG8gc2V0IGEgZGVsZWdhdGUgbmFtZXIgKFwiQHBhcmNlbC9uYW1lci1kZWZhdWx0XCIgYnkgZGVmYXVsdCknKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgZGVsZWdhdGVQYWNrYWdlID0gcGFja2FnZU1hbmFnZXIubG9hZChjb25maWcuY2hhaW4sIHByb2plY3RSb290KTtcbiAgICAgICAgICAgIGlmICghZGVsZWdhdGVQYWNrYWdlKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoYCdQYWNrYWdlICR7Y29uZmlnLmRlbGVnYXRlfScgaXMgbm90IGF2YWlsYWJsZS4gU2V0IHBhY2thZ2UuanNvbiNwYXJjZWwtbmFtZXItcmV3cml0ZTpjaGFpbiB0byBzZXQgYSBkZWxlZ2F0ZSBuYW1lciAoXCJAcGFyY2VsL25hbWVyLWRlZmF1bHRcIiBieSBkZWZhdWx0KWApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBkZWxlZ2F0ZSA9IGRlbGVnYXRlUGFja2FnZS5kZWZhdWx0W0NPTkZJR107XG4gICAgICAgICAgICBpZiAoIWRlbGVnYXRlKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoYFBhY2thZ2UgJyR7Y29uZmlnLmRlbGVnYXRlfScgaGFzIGJlZW4gZm91bmQsIGJ1dCBpdCdzIG5vdCBhIG5hbWVyLiBTZXQgcGFja2FnZS5qc29uI3BhcmNlbC1uYW1lci1yZXdyaXRlOmNoYWluIHRvIHNldCBhIGRlbGVnYXRlIG5hbWVyIChcIkBwYXJjZWwvbmFtZXItZGVmYXVsdFwiIGJ5IGRlZmF1bHQpYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZGVsZWdhdGUgPSBkZWxlZ2F0ZTtcbiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmNvbmZpZztcbiAgICB9LFxuXG4gICAgYXN5bmMgcmV3cml0ZShidW5kbGU6IHsgaWQ6IHN0cmluZyB9LCBidW5kbGVHcmFwaDoge30sIG9wdGlvbnM6IHt9LCBzdXBlck5hbWU6IHN0cmluZywgbG9nZ2VyKSB7XG4gICAgICAgIGNvbnN0IHJ1bGUgPSB0aGlzLmNvbmZpZy5zZWxlY3RSdWxlKHN1cGVyTmFtZSk7XG4gICAgICAgIGlmICghcnVsZSkge1xuICAgICAgICAgICAgcmV0dXJuIHN1cGVyTmFtZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBidW5kbGVIYXNoID0gJyc7XG5cbiAgICAgICAgaWYgKG9wdGlvbnMubW9kZSAhPT0gJ2RldmVsb3BtZW50JyB8fCB0aGlzLmNvbmZpZy5kZXZlbG9wbWVudEhhc2hpbmcpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy51c2VQYXJjZWxIYXNoKSB7XG4gICAgICAgICAgICAgICAgYnVuZGxlSGFzaCA9IGJ1bmRsZS5oYXNoUmVmZXJlbmNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsZXQgYXNzZXRzID0gW107XG4gICAgICAgICAgICAgICAgYnVuZGxlLnRyYXZlcnNlQXNzZXRzKChhc3NldCkgPT4gYXNzZXRzLnB1c2goYXNzZXQpKTtcblxuICAgICAgICAgICAgICAgIGxldCBoYXNoID0gY3J5cHRvLmNyZWF0ZUhhc2goJ21kNScpO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXNzZXRzLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzc2V0ID0gYXNzZXRzW2ldO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXNzZXQuZmlsZVBhdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbGVIYXNoID0gYXdhaXQgbWQ1RnJvbUZpbGVQYXRoKGFzc2V0LmZzLCBhc3NldC5maWxlUGF0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBoYXNoLnVwZGF0ZShbYXNzZXQuZmlsZVBhdGgsIGZpbGVIYXNoXS5qb2luKCc6JykpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYnVuZGxlSGFzaCA9IGhhc2guZGlnZXN0KCdoZXgnKS5zdWJzdHIoMCwgNik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBpZiB3ZSBuZWVkIGhhc2hpbmcgLSByZW1vdmUgYnVuZGxlIGhhc2ggcGxhY2Vob2xkZXJcbiAgICAgICAgaWYgKGJ1bmRsZUhhc2ggJiYgYnVuZGxlLmhhc2hSZWZlcmVuY2UpIHtcbiAgICAgICAgICAgIHN1cGVyTmFtZSA9IHN1cGVyTmFtZS5yZXBsYWNlKFwiLlwiICsgYnVuZGxlLmhhc2hSZWZlcmVuY2UsIFwiXCIpXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXdyaXRlID0gc3VwZXJOYW1lXG4gICAgICAgICAgICAucmVwbGFjZShydWxlLnRlc3QsIHJ1bGUudG8pXG4gICAgICAgICAgICAucmVwbGFjZSgveyguPyloYXNoKC4/KX0vLCBidW5kbGVIYXNoLmxlbmd0aCA+IDAgPyBgJDEke2J1bmRsZUhhc2h9JDJgIDogJycpO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5zaWxlbnQgIT09IHRydWUpXG4gICAgICAgICAgICBsb2dnZXIuaW5mbyh7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogYFJld3JpdGUgJHtzdXBlck5hbWV9IC0+ICR7cmV3cml0ZX1gXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmV3cml0ZTtcbiAgICB9XG59KTtcbiJdfQ==